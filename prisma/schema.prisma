// PostgreSQL Schema für Produktion
// Kopiere dies nach schema.prisma und ändere die DATABASE_URL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Editionen: Free, Silver, Gold (Admin legt Preise und Berechtigungen fest)
model Edition {
  id                    String   @id @default(cuid())
  code                  String   @unique // FREE | SILVER | GOLD
  name                  String
  annualPriceCents      Int      @default(0) // 0 = Free, sonst jährliche Gebühr in Cent
  order                 Int      @default(0)
  maxProjects           Int      @default(1) // Max. Projekte pro Hauptaccount
  maxProjectStaffPerProject Int   @default(0) // Max. Projektmitarbeiter pro Projekt
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  users         User[]
  categories    EditionCategory[]
  pages         EditionPage[]
  subscriptions Subscription[]

  @@map("editions")
}

// Welche Arbeitsbereiche (Categories) eine Edition nutzen darf
model EditionCategory {
  id         String  @id @default(cuid())
  editionId  String
  categoryId String // z.B. PROTOCOL, GUEST_LIST (Category.categoryId)
  createdAt  DateTime @default(now())

  edition Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)

  @@unique([editionId, categoryId])
  @@map("edition_categories")
}

// Welche festen Seiten eine Edition nutzen darf (invitations, checkin, reports, …)
model EditionPage {
  id        String   @id @default(cuid())
  editionId String
  pageId    String   // z.B. invitations, checkin, reports, audit-logs, guests, program_flow, tischplanung, vip-namensschilder, push-notifications
  createdAt DateTime @default(now())

  edition Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)

  @@unique([editionId, pageId])
  @@map("edition_pages")
}

// Benutzer-Überschreibung: darf User diese Kategorie (trotz Edition)?
model UserCategoryPermission {
  id         String  @id @default(cuid())
  userId     String
  categoryId String
  allowed   Boolean @default(true)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@map("user_category_permissions")
}

// Benutzer-Überschreibung: darf User diese Seite (trotz Edition)?
model UserPagePermission {
  id        String   @id @default(cuid())
  userId    String
  pageId    String
  allowed   Boolean  @default(true)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pageId])
  @@map("user_page_permissions")
}

// Abrechnung: jährliche Gebühren für Silver/Gold
model Subscription {
  id           String    @id @default(cuid())
  userId       String
  editionId    String
  periodStart  DateTime
  periodEnd    DateTime
  amountCents  Int
  status       String    @default("PENDING") // PENDING | PAID | CANCELLED
  paidAt       DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  edition Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// Hauptbenutzer-Kategorien (Baskan, Sekreter, …) – später Berechtigungen pro Kategorie
model MainUserCategory {
  id        String   @id @default(cuid())
  key       String   @unique // z.B. BASKAN, SEKRETER
  name      String   // Anzeigename z.B. Baskan
  order     Int      @default(0) // Sortierung
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]

  @@map("main_user_categories")
}

// Benutzer für die Anwendung
model User {
  id                   String   @id @default(cuid())
  email                String   @unique
  name                 String
  password             String
  role                 String   @default("COORDINATOR") // ADMIN | COORDINATOR – Admin sieht alles, verwaltet User/Editions
  editionId            String?  // Free / Silver / Gold – welche Bereiche/Seiten nutzbar
  mainUserCategoryId   String?  // Hauptbenutzer-Kategorie (Baskan, Sekreter, …) – gleiche Kategorie = gemeinsamer Projektzugriff
  editionExpiresAt     DateTime? // Ablauf bei bezahlten Editionen
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  mainUserCategory     MainUserCategory? @relation(fields: [mainUserCategoryId], references: [id], onDelete: SetNull)
  edition              Edition?                 @relation(fields: [editionId], references: [id], onDelete: SetNull)
  assignedTasks            TaskAssignment[]
  tasks                    Task[] // Direkt zugewiesene Aufgaben
  tasksCompletedBy         Task[] @relation("TaskCompletedBy")
  checklistItems           ChecklistItem[]
  responsibleCategories    Category[]
  PushSubscription         PushSubscription[]
  categoryPermissions      UserCategoryPermission[]
  pagePermissions          UserPagePermission[]
  subscriptions            Subscription[]
  passwordResetTokens      PasswordResetToken[]
  ownedProjects            Project[] // Hauptaccount: eigene Projekte
  projectMemberships       ProjectMember[] // Projektmitarbeiter in Projekten anderer
  responsibleProjectCategorySettings ProjectCategorySetting[] @relation("ProjectCategoryResponsibleUser")
  importedJotFormForms     JotFormForm[]
  jotFormSubmissionsEntered JotFormSubmission[] @relation("JotFormSubmissionEnteredBy")
  jotFormSubmissionsSubmitted JotFormSubmission[] @relation("JotFormSubmissionSubmittedBy")
  jotFormSubmitPermissions ProjectMemberJotFormPermission[]
  roomReservations         RoomReservation[]
  roomReservationsResponsible RoomReservation[] @relation("RoomReservationResponsible")
  roomReservationsEventLeader RoomReservation[] @relation("RoomReservationEventLeader")

  @@map("users")
}

// Passwort zurücksetzen: Token per E-Mail, einmalig gültig
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

// Projekt eines Hauptaccounts (z.B. "Iftar Organizasyon Sistemi")
model Project {
  id        String   @id @default(cuid())
  ownerId   String   // Hauptaccount (User)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner   User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  events  Event[]
  members ProjectMember[]
  categorySettings ProjectCategorySetting[]
  jotFormForms     JotFormForm[]
  jotFormSubmissions JotFormSubmission[]
  memberJotFormPermissions ProjectMemberJotFormPermission[]
  roomReservations  RoomReservation[]

  @@map("projects")
}

// Projekt-spezifische Kategorie-Details (Beschreibung/Verantwortlicher) – gilt nur im jeweiligen Projekt
model ProjectCategorySetting {
  id                String   @id @default(cuid())
  projectId         String
  categoryId        String   // verweist auf Category.categoryId (unique)
  description       String?
  responsibleUserId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category        Category @relation(fields: [categoryId], references: [categoryId], onDelete: Cascade)
  responsibleUser User?    @relation("ProjectCategoryResponsibleUser", fields: [responsibleUserId], references: [id], onDelete: SetNull)

  @@unique([projectId, categoryId])
  @@index([projectId])
  @@index([categoryId])
  @@map("project_category_settings")
}

// Projektmitarbeiter: User mit Zugriff auf ein Projekt (Berechtigungen vom Hauptaccount vergeben)
model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("MEMBER") // MEMBER | COORDINATOR
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryPermissions ProjectMemberCategoryPermission[]
  pagePermissions      ProjectMemberPagePermission[]

  @@unique([projectId, userId])
  @@map("project_members")
}

// Welche Kategorien ein Projektmitarbeiter in diesem Projekt nutzen darf (Teilmenge der Edition des Owners)
model ProjectMemberCategoryPermission {
  id         String   @id @default(cuid())
  projectId  String
  userId     String
  categoryId String
  allowed    Boolean  @default(true)
  createdAt  DateTime @default(now())

  member ProjectMember @relation(fields: [projectId, userId], references: [projectId, userId], onDelete: Cascade)

  @@unique([projectId, userId, categoryId])
  @@map("project_member_category_permissions")
}

// Welche Seiten ein Projektmitarbeiter in diesem Projekt nutzen darf
model ProjectMemberPagePermission {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  pageId    String
  allowed   Boolean  @default(true)
  createdAt DateTime @default(now())

  member ProjectMember @relation(fields: [projectId, userId], references: [projectId, userId], onDelete: Cascade)

  @@unique([projectId, userId, pageId])
  @@map("project_member_page_permissions")
}

// Iftar Event Details (gehört zu einem Projekt)
model Event {
  id                        String    @id @default(cuid())
  projectId                 String?   // Projekt des Hauptaccounts (nullable für Migration)
  title                     String
  date                      DateTime
  location                  String
  description               String?
  status                    String    @default("PLANNING")
  googleSheetsId            String? // Google Sheets Spreadsheet ID
  googleSheetsSheetName     String? // Sheet Name (default: 'Gästeliste')
  googleSheetsEnabled       Boolean   @default(false) // Synchronisation aktiviert
  googleSheetsLastSync      DateTime? // Letzte Synchronisation
  googleSheetsColumnMapping String? // JSON: Mapping von Sheet-Spalten zu DB-Feldern
  maxAccompanyingGuests     Int      @default(5) // Max. mitkommende Gäste pro Zusage (Einladungsliste)
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  project       Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  guests        Guest[]
  tasks         Task[]
  checklistItems ChecklistItem[]
  programItems  ProgramItem[]
  invitations   Invitation[]
  tablePlan     TablePlan?
  mediaItems    MediaItem[]
  jotFormSubmissions JotFormSubmission[]
  roomReservations RoomReservation[]

  @@map("events")
}

// Foto- und Video-Bereich: Uploads pro Event mit Titel, Text, Teilen-Checkboxen, Notizen
model MediaItem {
  id                   String   @id @default(cuid())
  eventId              String
  type                 String   // PHOTO | VIDEO
  fileName             String
  filePath             String   // z.B. /uploads/...
  fileType             String   // MIME-Type
  fileSize             Int      // Bytes
  title                String?
  text                 String?  // Kommentar/Beschreibung
  approvedForSharing   Boolean  @default(false) // Geprüft fürs Teilen
  sharedInstagram     Boolean  @default(false)
  sharedFacebook       Boolean  @default(false)
  sharedOtherMedia    Boolean  @default(false)
  notes                String?
  uploadedBy           String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("media_items")
}

// Tischplanung: Grundriss + Tische + Podeste pro Event
model TablePlan {
  id            String   @id @default(cuid())
  eventId       String   @unique
  floorPlanUrl  String?  // z.B. /uploads/floorplan-xxx.pdf
  planData      String?  // JSON: { tables: [...], podiums: [...] }
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("table_plans")
}

// Gäste / Davet Listesi
model Guest {
  id                    String    @id @default(cuid())
  eventId               String
  name                  String
  email                 String?
  phone                 String?
  title                 String? // Unvan/Title
  organization          String? // Kurum/Organization
  tableNumber           Int? // Masa numarası
  isVip                 Boolean   @default(false) // VIP misafir
  status                String    @default("INVITED")
  arrivalTime           DateTime? // Ankunftszeit am Event-Tag
  arrivalDate           DateTime? // Anreisedatum (wann kommt der Gast an)
  needsSpecialReception Boolean   @default(false) // Benötigt besonderen Empfang
  receptionBy           String? // Wer empfängt diesen Gast
  notes                 String?
  additionalData        String? // JSON: Alle zusätzlichen Spalten aus Google Sheets (1:1)
  checkInToken          String?   @unique // QR-Code-Check-in am Eventtag
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  event       Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  invitations Invitation[]

  @@map("guests")
}

// Zusätzliche Gäste (Begleitpersonen) pro Einladung – bei Zusage abgefragt
model AccompanyingGuest {
  id           String    @id @default(cuid())
  invitationId String
  firstName    String
  lastName     String
  funktion     String?   // Funktion/Rolle
  email        String?
  checkInToken String    @unique // Für QR-Code-Check-in
  arrivedAt    DateTime? // Am Eventtag: wann eingecheckt
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  invitation Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)

  @@index([invitationId])
  @@map("accompanying_guests")
}

// Aufgabenbereiche (9 Hauptbereiche)
model Task {
  id           String    @id @default(cuid())
  eventId      String
  category     String
  title        String
  description  String?
  status       String    @default("PENDING")
  priority     String    @default("MEDIUM")
  dueDate      DateTime?
  completedAt  DateTime?
  completedBy  String?   // Wer hat die Aufgabe erledigt (für Statistik)
  assignedTo   String?   // Direkter Verantwortlicher
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  event          Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  assignedUser   User?            @relation(fields: [assignedTo], references: [id], onDelete: SetNull)
  completedByUser User?            @relation("TaskCompletedBy", fields: [completedBy], references: [id], onDelete: SetNull)
  assignments    TaskAssignment[]
  checklistItems ChecklistItem[]
  attachments    Attachment[]

  @@map("tasks")
}

// Aufgaben-Zuweisungen
model TaskAssignment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  role      String? // Zusätzliche Rolle/Verantwortung
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("task_assignments")
}

// Checklisten-Items für jeden Bereich
model ChecklistItem {
  id          String    @id @default(cuid())
  eventId     String?
  taskId      String?
  category    String
  title       String
  description String?
  status      String    @default("NOT_STARTED")
  assignedTo  String?
  dueDate     DateTime?
  completedAt DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  event        Event?       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  task         Task?        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  assignedUser User?        @relation(fields: [assignedTo], references: [id], onDelete: SetNull)
  attachments  Attachment[]

  @@map("checklist_items")
}

// Protokoll-Einträge
model Protocol {
  id        String   @id @default(cuid())
  eventId   String
  category  String
  title     String
  content   String // Protokoll-Inhalt
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("protocols")
}

// Notizen und Dokumente
model Note {
  id                  String   @id @default(cuid())
  eventId             String?
  taskId              String?
  category            String?
  type                String? // MEETING, CALL, APPOINTMENT
  responsibleUserId   String? // Verantwortlicher (User ID)
  participantsUserIds String? // JSON Array von User IDs (TEXT)
  calledWithUserId    String? // Für CALL: mit welchem User telefoniert
  calledWithText      String? // Für CALL: Freitext falls kein User
  title               String
  content             String
  authorId            String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("notes")
}

// Programmpunkte für Zeitplanung
model ProgramItem {
  id          String   @id @default(cuid())
  eventId     String
  type        String // SPEECH, MUSIC, EZAN, QURAN, HITABET, IFTAR_START, SUNUCU
  title       String // Titel/Name des Programmpunkts
  speakerName String? // Name des Konuşmacı/Kuran okuyan/Ezan okuyan/Sunucu
  topic       String? // Konu/Thema
  duration    Int // Dauer in Minuten
  startTime   DateTime // Startzeit
  order       Int // Reihenfolge im Programm
  musicType   String? // Musiktyp (wenn type = MUSIC)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("program_items")
}

// Organisationsbereiche (editierbar)
model Category {
  id                String   @id @default(cuid())
  categoryId        String   @unique // Eindeutige ID (z.B. 'PROTOCOL', 'GUEST_LIST')
  name              String
  icon              String
  color             String
  description       String?
  responsibleUserId String? // Hauptverantwortlicher
  order             Int      @default(0) // Reihenfolge
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  responsibleUser User? @relation(fields: [responsibleUserId], references: [id], onDelete: SetNull)
  projectSettings ProjectCategorySetting[]

  @@map("categories")
}

// Dateianhänge für Tasks und ChecklistItems
model Attachment {
  id              String   @id @default(cuid())
  taskId          String?
  checklistItemId String?
  fileName        String
  filePath        String // Pfad zur Datei im public/uploads Ordner
  fileType        String // MIME-Type (image/png, application/pdf, etc.)
  fileSize        Int // Größe in Bytes
  uploadedBy      String?
  createdAt       DateTime @default(now())

  task          Task?          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  checklistItem ChecklistItem? @relation(fields: [checklistItemId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

// Audit-Log für alle Benutzeraktionen
model AuditLog {
  id          String   @id @default(cuid())
  userId      String? // User ID (null wenn nicht authentifiziert)
  userEmail   String? // User E-Mail (für bessere Lesbarkeit)
  action      String // CREATE, UPDATE, DELETE, VIEW, CLICK, LOGIN, LOGOUT, etc.
  entityType  String? // GUEST, TASK, CHECKLIST, NOTE, CATEGORY, USER, etc.
  entityId    String? // ID der betroffenen Entity
  eventId     String? // Event ID (falls relevant)
  category    String? // Kategorie (falls relevant)
  description String? // Beschreibung der Aktion
  oldValues   String? // JSON: Vorherige Werte (bei Updates)
  newValues   String? // JSON: Neue Werte (bei Updates/Creates)
  ipAddress   String? // IP-Adresse des Benutzers
  userAgent   String? // User-Agent (Browser/Device Info)
  url         String? // URL/Route wo die Aktion stattfand
  metadata    String? // JSON: Zusätzliche Metadaten
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([eventId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// Push Notification Subscriptions
model PushSubscription {
  id        String   @id @default(cuid())
  userId    String? // Optional: Benutzer-ID
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

// Email-Konfiguration (Gmail, iCloud, SMTP/IMAP oder Mailjet API)
model EmailConfig {
  id               String   @id @default(cuid())
  name             String // Name der Konfiguration
  type             String // GMAIL | ICLOUD | IMAP | MAILJET
  email            String // Absender-E-Mail
  senderName       String? // Anzeigename des Absenders (z. B. "Iftar Organizasyon" oder "Max Mustermann")
  password         String? // Passwort (verschlüsselt)
  appPassword      String? // Gmail App-Passwort
  imapHost         String? // IMAP Host (z.B. imap.gmail.com)
  imapPort         Int? // IMAP Port (z.B. 993)
  smtpHost         String? // SMTP Host
  smtpPort         Int? // SMTP Port (z.B. 587)
  smtpUseStartTls  Boolean  @default(false) // Eigener Mailserver: STARTTLS-Verschlüsselung (z.B. Port 587)
  mailjetApiKey    String? // Mailjet API Key (public)
  mailjetApiSecret String? // Mailjet API Secret (private)
  isActive         Boolean  @default(false) // Nur eine aktive Konfiguration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invitations Invitation[]

  @@map("email_configs")
}

// Email-Templates für Einladungen (mehrsprachig, optional pro Kategorie aus Gästeliste)
model EmailTemplate {
  id        String   @id @default(cuid())
  name      String // Template-Name
  language  String // de, tr, en, ar, etc.
  category  String   @default("") // "" = global; sonst Kategorie-Key (z. B. protokol, gasteliste) – kann TR/DE in Gästeliste sein
  subject   String // Betreff
  body      String // HTML-Body
  plainText String? // Plain-Text-Version
  isDefault Boolean  @default(false) // Standard-Template für (Sprache + Kategorie)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invitations Invitation[]

  @@map("email_templates")
}

// Einladungen
model Invitation {
  id            String    @id @default(cuid())
  guestId       String
  eventId       String
  templateId    String? // Verwendetes Template
  language      String // Sprache der Einladung
  subject       String
  body          String // HTML-Body
  acceptToken   String    @unique // Token für Zusage-Link
  declineToken  String    @unique // Token für Absage-Link
  trackingToken String    @unique // Token für Email-Tracking
  sentAt        DateTime? // Wann wurde Email gesendet
  sentByPost    Boolean   @default(false) // Wurde per Post gesendet
  openedAt      DateTime? // Wann wurde Email geöffnet (Tracking)
  respondedAt   DateTime? // Wann wurde geantwortet
  response      String? // ACCEPTED, DECLINED, PENDING
  accompanyingGuestsCount Int? // Anzahl mitkommender Gäste (bei Zusage abgefragt)
  emailConfigId String? // Welche Email-Konfiguration wurde verwendet
  errorMessage  String? // Fehlermeldung falls Versand fehlgeschlagen
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  guest             Guest             @relation(fields: [guestId], references: [id], onDelete: Cascade)
  event             Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  template          EmailTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  emailConfig       EmailConfig?      @relation(fields: [emailConfigId], references: [id], onDelete: SetNull)
  accompanyingGuests AccompanyingGuest[]

  @@index([guestId])
  @@index([eventId])
  @@index([acceptToken])
  @@index([declineToken])
  @@index([trackingToken])
  @@index([response])
  @@map("invitations")
}

// Öffentliche Registrierung von Interessenten (z. B. UID Iftar, Şube Başkanları)
model EventRegistration {
  id            String   @id @default(cuid())
  eventSlug     String   // z. B. "uid-iftar", "sube-baskanlari"
  firstName     String   // Vorname
  lastName      String   // Name
  district      String?  // Bezirk
  sube          String?  // Şube (z. B. bei Şube Başkanları: aus welchem Bezirk/Şube)
  phone         String?
  email         String
  participating Boolean @default(true) // Ich nehme teil
  notes         String?  // Notizen / Vorschläge
  createdAt     DateTime @default(now())

  @@index([eventSlug])
  @@index([createdAt])
  @@map("event_registrations")
}

// ========== JotForm-Integration: Etkinlik Formu & Etkinlik Raporu ==========
// Formulardaten können in die App eingegeben werden; nur berechtigte User dürfen an JotForm senden.
// Import der Felder aus JotForm-URL darf nur der Projekt-Inhaber.

model JotFormForm {
  id               String    @id @default(cuid())
  projectId        String
  formType         String    // ETKINLIK_FORMU | ETKINLIK_RAPORU
  jotformFormId    String?   // JotForm Form-ID (aus URL)
  jotformUrl       String?   // Gespeicherte JotForm-URL
  importedAt       DateTime?
  importedByUserId String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  importedBy User?              @relation(fields: [importedByUserId], references: [id], onDelete: SetNull)
  fields     JotFormFormField[]

  @@unique([projectId, formType])
  @@index([projectId])
  @@map("jotform_forms")
}

model JotFormFormField {
  id               String   @id @default(cuid())
  jotFormFormId    String
  jotformQuestionId String  // Externe JotForm-Fragen-ID (bei Radio/Checkbox oft name[] oder name)
  label            String
  type             String   // text, textarea, dropdown, radio, checkbox
  order            Int      @default(0)
  required         Boolean  @default(false)
  options          Json?    // [{ value: string, label: string }] für dropdown, radio, checkbox
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  form JotFormForm @relation(fields: [jotFormFormId], references: [id], onDelete: Cascade)

  @@unique([jotFormFormId, jotformQuestionId])
  @@index([jotFormFormId])
  @@map("jotform_form_fields")
}

// Eintrag: von jedem Projektmitglied ausfüllbar; nur Berechtigte dürfen an JotForm senden
model JotFormSubmission {
  id                  String    @id @default(cuid())
  projectId           String
  eventId             String?   // Optional: welchem Event zugeordnet
  formType            String    // ETKINLIK_FORMU | ETKINLIK_RAPORU
  enteredByUserId     String    // Wer hat die Daten eingegeben
  submittedByUserId   String?   // Wer hat an JotForm gesendet (null = nur Entwurf)
  submittedAt         DateTime?
  jotformSubmissionId String?   // JotForm-Übermittlungs-ID nach dem Senden
  data                String    // JSON: Feldname/Feld-ID -> Wert
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  event      Event?  @relation(fields: [eventId], references: [id], onDelete: SetNull)
  enteredBy  User    @relation("JotFormSubmissionEnteredBy", fields: [enteredByUserId], references: [id], onDelete: Cascade)
  submittedBy User?  @relation("JotFormSubmissionSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([eventId])
  @@index([formType])
  @@index([submittedAt])
  @@map("jotform_submissions")
}

// Nur diese User dürfen Formulardaten an JotForm senden (pro Projekt)
model ProjectMemberJotFormPermission {
  id                  String   @id @default(cuid())
  projectId           String
  userId              String
  canSubmitToJotform  Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@map("project_member_jotform_permissions")
}

// ========== Raum-Reservierungen ==========
// Räume werden vom Admin angelegt; Reservierungen von Admin und Hauptbenutzer (manuell oder aus Projekt)
model Room {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reservations RoomReservation[]

  @@map("rooms")
}

model RoomReservation {
  id                   String    @id @default(cuid())
  roomId               String
  projectId             String?
  eventId               String?
  reservedByUserId      String
  responsibleUserId     String?   // Verantwortlicher Hauptnutzer
  eventLeaderId        String?   // Leiter der Veranstaltung
  title                 String
  startAt               DateTime
  endAt                 DateTime?
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  room          Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  project       Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  event         Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)
  reservedBy    User     @relation(fields: [reservedByUserId], references: [id], onDelete: Cascade)
  responsibleUser User?  @relation("RoomReservationResponsible", fields: [responsibleUserId], references: [id], onDelete: SetNull)
  eventLeader   User?    @relation("RoomReservationEventLeader", fields: [eventLeaderId], references: [id], onDelete: SetNull)

  @@index([roomId])
  @@index([startAt])
  @@index([projectId])
  @@map("room_reservations")
}
